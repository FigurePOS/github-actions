name: Node Test Unit
description: Runs the linters and unit tests for the Node.js app

inputs:
  buddy-trigger-url:
    description: The Buddy trigger URL
    required: true
  env:
    description: Environment variables for the tests
    required: false
  service-name:
    description: The service name
    required: true

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set Up Node.js
      uses: FigurePOS/github-actions/.github/actions/setup-node@v1

    - name: Install Dependencies
      uses: FigurePOS/github-actions/.github/actions/install-dependencies@v1

    - name: Set Environment Variables
      shell: bash
      run: |
        if [ -n '${{ inputs.env }}' ]; then
          echo '${{ inputs.env }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read -r line; do
            secret=${line#*=}
            echo "::add-mask::$secret"
            echo "$line" >> "$GITHUB_ENV"
          done
        fi

    - name: Run Linters and Unit Tests
      shell: bash
      run: yarn run test:ci 2>/dev/null || yarn run ci

    - name: Send Slack Notification About Failure
      if: failure() && github.ref == 'refs/heads/master'
      uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
      with:
        job-name: test-unit
        service-name: ${{ inputs.service-name }}
        trigger-url: ${{ inputs.buddy-trigger-url }}

