name: Integration
on: 
  workflow_call:
    inputs:
      aws-region:
        description: "AWS region"
        required: false
        type: string
        default: "us-east-1"
      db-tunnel-mapping:
        description: "DB tunnel mapping"
        required: false
        type: string
        default: ""
      docker-command:
        description: "Command to start the service in Docker"
        required: false
        type: string
        default: "build/index.js"
      ecr-repository-name:
        description: "ECR Docker repository name"
        required: true
        type: string
      runner: 
        description: "Runner"
        required: false
        type: string
        default: "blacksmith-4vcpu-ubuntu-2204"
      service-name:
        description: "Service name"
        required: true
        type: string
    secrets:
      BUDDY_TRIGGER_URL:
        description: "Buddy trigger URL"

permissions:
  # Required to query workflow run status and trigger other workflows
  actions: read
  # Allows the workflow to create and update check runs (e.g., test results, linting)
  checks: write 
  # Needed to checkout repository code and read repository contents
  contents: read
  # Required for OIDC authentication with AWS
  id-token: write
  # Allows reading from GitHub container registry (ghcr.io)
  packages: read
  # Enables commenting and updating PR status (e.g., posting test results, terraform plans)
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
    
jobs:
  build:
    runs-on: ${{ inputs.runner }}
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set Up Node.js
        uses: FigurePOS/github-actions/.github/actions/setup-node@v1
      
      - name: Install Dev Dependencies
        uses: FigurePOS/github-actions/.github/actions/install-dependencies@v1

      - name: Yarn Build
        run: yarn build

      - name: Install Prod Dependencies
        uses: FigurePOS/github-actions/.github/actions/install-dependencies@v1
        with:
          prod: true

      - name: Build Image
        uses: FigurePOS/github-actions/.github/actions/docker-build-image@v1
        with:
          repository-name: ${{ inputs.ecr-repository-name }}
          service-name: ${{ inputs.service-name }}

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}
  
  test-unit:
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Up Node.js
        uses: FigurePOS/github-actions/.github/actions/setup-node@v1

      - name: Install Dependencies
        uses: FigurePOS/github-actions/.github/actions/install-dependencies@v1
        
      - name: Run Linters and Unit Tests
        run: yarn run ci

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}
  
  test-e2e:
    runs-on: ${{ inputs.runner }}
    needs:
      - build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Up Node.js
        uses: FigurePOS/github-actions/.github/actions/setup-node@v1

      - name: Install Dependencies
        uses: FigurePOS/github-actions/.github/actions/install-dependencies@v1

      - name: Load Docker Image
        uses: FigurePOS/github-actions/.github/actions/docker-load-image@v1
        with:
          service-name: ${{ inputs.service-name }}

      - name: Install Prod Dependencies
        uses: FigurePOS/github-actions/.github/actions/install-dependencies@v1
        with:
          prod: true

      - run: cd tests && yarn install --frozen-lockfile

      - name: Run Tests
        run: |-
          sha_short=$(git rev-parse --short ${{ github.sha }})
          export SERVICE_DOCKER_IMAGE=637192944017.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.ecr-repository-name }}:$sha_short
          TEST_CMD="yarn start" yarn test:integration:prepare
        env:
          SERVICE_DOCKER_COMMAND: node --enable-source-maps ${{ inputs.docker-command }}

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}
  
  terraform-validate:
    runs-on: ${{ inputs.runner }}
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Terraform Init
        uses: FigurePOS/github-actions/.github/actions/terraform-init@v1
        with:
          db-tunnel-mapping: ${{ inputs.db-tunnel-mapping }}
          env: development
          service-name: ${{ inputs.service-name }}

      - name: Terraform Validate
        uses: FigurePOS/github-actions/.github/actions/terraform-validate@v1
        with:
          aws-account-id: '880892332156'
          env: development
          service-name: ${{ inputs.service-name }}

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}

  terraform-plan-dev:
    if: github.event_name == 'pull_request'
    needs:
      - terraform-validate
    runs-on: ${{ inputs.runner }}
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Terraform Init
        uses: FigurePOS/github-actions/.github/actions/terraform-init@v1
        with:
          db-tunnel-mapping: ${{ inputs.db-tunnel-mapping }}
          env: development
          service-name: ${{ inputs.service-name }}

      - name: Terraform Plan
        uses: FigurePOS/github-actions/.github/actions/terraform-plan@v1
        with:
          aws-account-id: '880892332156'
          env: development
          service-name: ${{ inputs.service-name }}

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}
  
  terraform-plan-prod:
    if: github.event_name == 'pull_request'
    needs:
      - terraform-validate
    runs-on: ${{ inputs.runner }}
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Terraform Init
        uses: FigurePOS/github-actions/.github/actions/terraform-init@v1
        with:
          db-tunnel-mapping: ${{ inputs.db-tunnel-mapping }}
          env: production
          service-name: ${{ inputs.service-name }}

      - name: Terraform Plan
        uses: FigurePOS/github-actions/.github/actions/terraform-plan@v1
        with:
          aws-account-id: '682919404744'
          env: production
          service-name: ${{ inputs.service-name }}

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}
  
  push:
    if: github.ref == 'refs/heads/master'
    needs:
      - build
      - test-e2e
      - test-unit
    runs-on: ${{ inputs.runner }}
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load docker image
        uses: FigurePOS/github-actions/.github/actions/docker-load-image@v1
        with:
          service-name: ${{ inputs.service-name }}

      - name: Push Docker Image
        uses: FigurePOS/github-actions/.github/actions/docker-push-image@v1
        with:
          repository-name: ${{ inputs.ecr-repository-name }}
          service-name: ${{ inputs.service-name }}

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}
  
  terraform-deploy-dev:
    if: github.ref == 'refs/heads/master'
    needs:
      - push
    runs-on: ${{ inputs.runner }}
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    steps:
      - uses: actions/checkout@v4

      - name: Terraform Init
        uses: FigurePOS/github-actions/.github/actions/terraform-init@v1
        with:
          db-tunnel-mapping: ${{ inputs.db-tunnel-mapping }}
          env: development
          service-name: ${{ inputs.service-name }}

      - name: Terraform Deploy
        uses: FigurePOS/github-actions/.github/actions/terraform-apply@v1
        with:
          aws-account-id: '880892332156'
          env: development
          service-name: ${{ inputs.service-name }}

      - uses: FigurePOS/github-actions/.github/actions/buddy-notify-deploy-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}

      - name: Send Slack Notification About Failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: FigurePOS/github-actions/.github/actions/buddy-notify-fail-service@v1
        with:
          service-name: ${{ inputs.service-name }}
          trigger-url: ${{ secrets.BUDDY_TRIGGER_URL }}
